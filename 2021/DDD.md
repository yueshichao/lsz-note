> 参考：[阿里技术专家详解 DDD 系列 第一讲- Domain Primitive](https://zhuanlan.zhihu.com/p/340911587)
> [团队开发框架实战—CQRS架构](https://www.jianshu.com/p/d4ca2133875c)
> [阿里技术专家详解DDD系列 第二讲 - 应用架构](https://zhuanlan.zhihu.com/p/343388831)
> [阿里技术专家详解DDD系列 第三讲 - Repository模式](https://zhuanlan.zhihu.com/p/348706530)
> [DDD 微服务落地实战](https://www.bilibili.com/video/BV1PM4y1L7Nh)  
> 


# 软件退化

## 退化的根源

直接原因是需求的变更，根本原因是与真实世界逻辑有偏差

## 杜绝软件退化：两顶帽子

> 举例：原本支付流程仅有计价支付流程，后来需要计算会员减免、优惠券等信息，
> 如果我们在原有代码上修改，会导致流程越来越繁琐
> 

开放封闭原则（OCP）
1. Open for Extension: 需求变更时，可以对软件功能进行拓展
2. Close for Modification: 修改代码的同时，不会影响系统原有功能

> 此时我们可以抽象出优惠策略，每次新增一种优惠方式就新增一个策略
> 

# 以电商支付为例演练DDD

## 起初的软件模型

以订单流程为例：  
1个订单：1个用户、n个商品等信息、n个订单详情  
1个商品：1家供货商  

## 商品折扣的需求变更

> 单一职责原则  
> 《敏捷软件开发：原则、模式与实践》中提到：一个职责就是软件变化的一个原因  
> 如何理解？因为同一个原因变更的代码需要放到同一个模块中  
> 按照这样的设计原则，需求变化时变动的代码最少  
> 


需求变更时，折扣的代码需要改动付款的代码吗？  
那么需要思考付款与折扣的关系  
付款变化折扣要变吗？  
折扣变化付款要变吗？  
限时折扣变化限量折扣需要变更吗？  
限量折扣变化限时折扣需要变更吗？  

思考完得出结论：
折扣需要单独拎出一个接口  

## VIP会员的需求变更

用户变更时VIP是否要变？  
VIP变化时用户是否要变？  

用户负责注册、注销等业务
VIP会员负责折扣、福利等业务

于是得出结论：用户与会员1对1的关系，下单流程调用VIP会员的接口

## 支付方式的需求变更

借用适配器模式，封装变化的支付方式


# 落地到数据库设计

领域对象的关系：1对1，1对n，n对n，继承  

数据表设计时仅能体现数据结构，不能体现业务逻辑，尤其继承设计时，关系型数据库不太方便，
但也有以下三种设计方式：  

1. 所有字段都体现在一张表中（可能造成表数据稀疏）
2. 每个子类一张表（查询全部时需要汇总所有表）
3. 父类共同信息一张表，其他信息放各自拓展表

> 例如商品信息，共同属性是名称、品类、规格、价格等，
> 子类不同的属性，例如划线价、物流配置，不是每种商品都有，也不是都一样的
> 普通商品可能没有划线价，虚拟商品可能没有物流，但需要其他配置信息
> 

除此之外，可以使用NoSQL来构建宽表，避免关系型数据库的join性能影响  

# 指导程序设计

- 实体与值对象的区分：可变性是实体的特点，不变性是值对象的本质

## 贫血模型 VS 充血模型


# 聚合、仓库与工厂

# 限界上下文

限界上下文是业务的逻辑边界，微服务是物理边界，

限界上下文指导微服务的拆分

# 事件风暴

软件设计第一步：需求分析，
前提是统一语言建模，因为产品不一定明白研发语言，研发不一定明白产品语言

解决方案：事件风暴，事件即事实，业务中已经发生的事就是事实

# DDD的真谛：领域建模，深入理解业务

之前用户怎么提需求，我们就怎么做，但DDD要求我们主动理解业务，掌握领域知识，

实践思路：
1. 对业务理解比较粗略时，从主要流程开始建模
2. 不断丰富领域细节，遵循开闭原则，不断重构再加新功能

## 基于限界上下文的领域建模

举例：
三个领域模型：饭店管理，用户下单，用户注册

1. 饭店管理：管理菜单、饭店
2. 用户下单：管理菜品明细、订单、支付、发票
3. 用户注册：管理用户、地址

对于用户下单而言，饭店管理和用户注册，都是支撑域，只是需要他们的部分信息。
对于饭店接单而言，也是如此

原本贫血模型，需要为菜品明细、订单分别建立Dao，
现在充血模型，只是一个订单Dao，被包含在订单工厂中

## 深入理解业务与模型重构

1. 初期认为送餐地址就是下单用户，但其实不是，于是模型重构后，用户地址增加联系人字段
2. 用户下单后需要取消订单，订单新增取消时间字段，对饭店接单、骑士配送上下文是否有影响

## 订单状态跟踪

下单、接单、派送，每个领域事件都发出通知，订单查询服务冗余订单数据保存到表中

# 微服务落地的技术实践

## 如何提供接口？
接口规划，尽可能少的接口提供出去，以便于维护
接口变更时，尽可能向前兼容，甚至新开一个接口也最好别修改原有接口

## 数据关联查询

NoSQL











